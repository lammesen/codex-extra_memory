name: release-stable

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-stable-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-stable:
    name: release-stable
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Set up Rust stable
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable

      - name: Authenticate to crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec

      - name: Resolve release version from tag
        id: version
        shell: bash
        run: |
          if [ "${GITHUB_REF_TYPE}" != "tag" ]; then
            echo "This workflow must run against a tag ref (vX.Y.Z)"
            exit 1
          fi

          if [[ ! "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must match vX.Y.Z for stable releases"
            exit 1
          fi

          TAG_VERSION="${GITHUB_REF_NAME#v}"
          BASE_VERSION="$(awk '
            $0 ~ /^\[workspace\.package\]/ { in_section=1; next }
            in_section && $0 ~ /^\[/ { in_section=0 }
            in_section && $0 ~ /^version = / {
              gsub(/version = "/, "", $0)
              gsub(/"/, "", $0)
              print $0
              exit
            }
          ' Cargo.toml)"

          if [ -z "$BASE_VERSION" ]; then
            echo "Unable to read workspace.package version"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$BASE_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match workspace.package version ($BASE_VERSION)"
            exit 1
          fi

          echo "version=${TAG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${TAG_VERSION}" >> "$GITHUB_ENV"
          echo "Publishing stable version: ${TAG_VERSION}"

      - name: Check workspace
        run: cargo check --workspace --locked

      - name: Publish crates
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          crate_version_exists() {
            local crate="$1"
            curl --silent --show-error --fail "https://crates.io/api/v1/crates/${crate}/${VERSION}" >/dev/null 2>&1
          }

          publish_crate() {
            local crate="$1"

            if crate_version_exists "$crate"; then
              echo "${crate}@${VERSION} already exists, skipping"
              return 0
            fi

            local attempt=1
            while [ "$attempt" -le 5 ]; do
              echo "Publishing ${crate}@${VERSION} (attempt ${attempt}/5)"
              local publish_output
              set +e
              publish_output="$(cargo publish -p "$crate" --locked --token "$CARGO_REGISTRY_TOKEN" 2>&1)"
              local publish_status=$?
              set -e
              printf '%s\n' "$publish_output"

              if [ "$publish_status" -eq 0 ]; then
                echo "Published ${crate}@${VERSION}"
                return 0
              fi

              if crate_version_exists "$crate"; then
                echo "${crate}@${VERSION} became visible after failed attempt, continuing"
                return 0
              fi

              if [ "$attempt" -lt 5 ]; then
                sleep 20
              fi
              attempt=$((attempt + 1))
            done

            echo "Failed publishing ${crate}@${VERSION}"
            return 1
          }

          publish_crate codex-extra-memory-core
          publish_crate codex-extra-memory-mcp
          publish_crate codex-extra-memory

      - name: Create source archive
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git archive \
            --format=tar.gz \
            --prefix="codex-extra-memory-${VERSION}/" \
            -o "codex-extra-memory-${VERSION}.tar.gz" \
            "${GITHUB_SHA}"

      - name: Attest source archive provenance (non-blocking)
        continue-on-error: true
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a
        with:
          subject-path: codex-extra-memory-${{ steps.version.outputs.version }}.tar.gz

      - name: Create GitHub release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          prerelease: false
          files: codex-extra-memory-${{ steps.version.outputs.version }}.tar.gz
          body: |
            crates.io publish completed for `${{ steps.version.outputs.version }}`.

            Install:
            - `cargo install codex-extra-memory --version ${{ steps.version.outputs.version }}`
            - `cargo install codex-extra-memory-mcp --version ${{ steps.version.outputs.version }}`
