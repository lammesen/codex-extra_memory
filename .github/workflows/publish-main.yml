name: publish-main

on:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: publish-main
  cancel-in-progress: false

jobs:
  publish-prerelease:
    name: publish-prerelease
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Set up Rust stable
        run: |
          rustup toolchain install stable --profile minimal
          rustup default stable

      - name: Authenticate to crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec

      - name: Compute CI version
        id: version
        shell: bash
        run: |
          BASE_VERSION="$(awk '
            $0 ~ /^\[workspace\.package\]/ { in_section=1; next }
            in_section && $0 ~ /^\[/ { in_section=0 }
            in_section && $0 ~ /^version = / {
              gsub(/version = "/, "", $0)
              gsub(/"/, "", $0)
              print $0
              exit
            }
          ' Cargo.toml)"

          if [ -z "$BASE_VERSION" ]; then
            echo "Unable to read workspace.package version"
            exit 1
          fi

          if [[ "$BASE_VERSION" == *-* || "$BASE_VERSION" == *+* ]]; then
            echo "workspace.package version must be stable semver (no pre-release/build metadata)"
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          CI_VERSION="${BASE_VERSION}-ci.${GITHUB_RUN_NUMBER}.${SHORT_SHA}"
          echo "ci_version=${CI_VERSION}" >> "$GITHUB_OUTPUT"
          echo "CI_VERSION=${CI_VERSION}" >> "$GITHUB_ENV"
          echo "Publishing version: ${CI_VERSION}"

      - name: Set workspace version for this run
        shell: bash
        env:
          CI_VERSION: ${{ steps.version.outputs.ci_version }}
        run: |
          awk -v ci_version="$CI_VERSION" '
            BEGIN { in_workspace_package = 0 }
            /^\[workspace\.package\]$/ {
              in_workspace_package = 1
              print
              next
            }
            /^\[/ {
              if (in_workspace_package) {
                in_workspace_package = 0
              }
            }
            in_workspace_package && /^version = "/ {
              print "version = \"" ci_version "\""
              next
            }
            /^codex-extra-memory-core = \{ version = ".*", path = "crates\/codex-extra-memory-core" \}$/ {
              print "codex-extra-memory-core = { version = \"" ci_version "\", path = \"crates/codex-extra-memory-core\" }"
              next
            }
            { print }
          ' Cargo.toml > Cargo.toml.tmp
          mv Cargo.toml.tmp Cargo.toml

      - name: Check workspace
        run: cargo check --workspace

      - name: Publish crates
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
          CI_VERSION: ${{ steps.version.outputs.ci_version }}
        run: |
          crate_version_exists() {
            local crate="$1"
            curl --silent --show-error --fail "https://crates.io/api/v1/crates/${crate}/${CI_VERSION}" >/dev/null 2>&1
          }

          publish_crate() {
            local crate="$1"

            if crate_version_exists "$crate"; then
              echo "${crate}@${CI_VERSION} already exists, skipping"
              return 0
            fi

            local attempt=1
            while [ "$attempt" -le 5 ]; do
              echo "Publishing ${crate}@${CI_VERSION} (attempt ${attempt}/5)"
              local publish_output
              set +e
              publish_output="$(cargo publish -p "$crate" --allow-dirty --token "$CARGO_REGISTRY_TOKEN" 2>&1)"
              local publish_status=$?
              set -e
              printf '%s\n' "$publish_output"

              if [ "$publish_status" -eq 0 ]; then
                echo "Published ${crate}@${CI_VERSION}"
                return 0
              fi

              if crate_version_exists "$crate"; then
                echo "${crate}@${CI_VERSION} became visible after failed attempt, continuing"
                return 0
              fi

              local retry_after
              retry_after="$(printf '%s\n' "$publish_output" | sed -n 's/.*Please try again after \(.* GMT\).*/\1/p' | tail -n 1)"
              if [ -n "$retry_after" ]; then
                local now_epoch
                local retry_epoch
                now_epoch="$(date -u +%s)"
                retry_epoch="$(date -u -d "$retry_after" +%s 2>/dev/null || true)"
                if [ -n "$retry_epoch" ] && [ "$retry_epoch" -gt "$now_epoch" ]; then
                  local sleep_seconds
                  sleep_seconds="$((retry_epoch - now_epoch + 5))"
                  echo "Rate limited by crates.io, sleeping ${sleep_seconds}s until ${retry_after}"
                  sleep "$sleep_seconds"
                fi
              fi

              if [ "$attempt" -lt 5 ]; then
                sleep 20
              fi
              attempt=$((attempt + 1))
            done

            echo "Failed publishing ${crate}@${CI_VERSION}"
            return 1
          }

          publish_crate codex-extra-memory-core
          publish_crate codex-extra-memory-mcp
          publish_crate codex-extra-memory

      - name: Create GitHub release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: v${{ steps.version.outputs.ci_version }}
          name: v${{ steps.version.outputs.ci_version }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          prerelease: true
          body: |
            crates.io publish completed for `${{ steps.version.outputs.ci_version }}`.

            Install:
            - `cargo install codex-extra-memory --version ${{ steps.version.outputs.ci_version }}`
            - `cargo install codex-extra-memory-mcp --version ${{ steps.version.outputs.ci_version }}`
