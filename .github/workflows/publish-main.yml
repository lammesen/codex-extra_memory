name: Publish crates on main

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: publish-main
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Validate token
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "CARGO_REGISTRY_TOKEN is required"
            exit 1
          fi

      - name: Compute CI version
        id: version
        shell: bash
        run: |
          BASE_VERSION="$(awk '
            $0 ~ /^\[workspace\.package\]/ { in_section=1; next }
            in_section && $0 ~ /^\[/ { in_section=0 }
            in_section && $0 ~ /^version = / {
              gsub(/version = "/, "", $0)
              gsub(/"/, "", $0)
              print $0
              exit
            }
          ' Cargo.toml)"

          if [ -z "$BASE_VERSION" ]; then
            echo "Unable to read workspace.package version"
            exit 1
          fi

          if [[ "$BASE_VERSION" == *-* || "$BASE_VERSION" == *+* ]]; then
            echo "workspace.package version must be stable semver (no pre-release/build metadata)"
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          CI_VERSION="${BASE_VERSION}-ci.${GITHUB_RUN_NUMBER}.${SHORT_SHA}"
          echo "ci_version=${CI_VERSION}" >> "$GITHUB_OUTPUT"
          echo "CI_VERSION=${CI_VERSION}" >> "$GITHUB_ENV"
          echo "Publishing version: ${CI_VERSION}"

      - name: Set workspace version for this run
        shell: bash
        env:
          CI_VERSION: ${{ steps.version.outputs.ci_version }}
        run: |
          awk -v ci_version="$CI_VERSION" '
            BEGIN { in_workspace_package = 0 }
            /^\[workspace\.package\]$/ {
              in_workspace_package = 1
              print
              next
            }
            /^\[/ {
              if (in_workspace_package) {
                in_workspace_package = 0
              }
            }
            in_workspace_package && /^version = "/ {
              print "version = \"" ci_version "\""
              next
            }
            /^codex-extra-memory-core = \{ version = ".*", path = "crates\/codex-extra-memory-core" \}$/ {
              print "codex-extra-memory-core = { version = \"" ci_version "\", path = \"crates/codex-extra-memory-core\" }"
              next
            }
            { print }
          ' Cargo.toml > Cargo.toml.tmp
          mv Cargo.toml.tmp Cargo.toml

      - name: Check workspace
        run: cargo check --workspace

      - name: Publish crates
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          CI_VERSION: ${{ steps.version.outputs.ci_version }}
        run: |
          crate_version_exists() {
            local crate="$1"
            curl --silent --show-error --fail "https://crates.io/api/v1/crates/${crate}/${CI_VERSION}" >/dev/null 2>&1
          }

          publish_crate() {
            local crate="$1"

            if crate_version_exists "$crate"; then
              echo "${crate}@${CI_VERSION} already exists, skipping"
              return 0
            fi

            local attempt=1
            while [ "$attempt" -le 5 ]; do
              echo "Publishing ${crate}@${CI_VERSION} (attempt ${attempt}/5)"
              if cargo publish -p "$crate" --allow-dirty --token "$CARGO_REGISTRY_TOKEN"; then
                echo "Published ${crate}@${CI_VERSION}"
                return 0
              fi

              if crate_version_exists "$crate"; then
                echo "${crate}@${CI_VERSION} became visible after failed attempt, continuing"
                return 0
              fi

              if [ "$attempt" -lt 5 ]; then
                sleep 20
              fi
              attempt=$((attempt + 1))
            done

            echo "Failed publishing ${crate}@${CI_VERSION}"
            return 1
          }

          publish_crate codex-extra-memory-core
          publish_crate codex-extra-memory-mcp
          publish_crate codex-memory

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.ci_version }}
          name: v${{ steps.version.outputs.ci_version }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          prerelease: true
          body: |
            crates.io publish completed for `${{ steps.version.outputs.ci_version }}`.

            Install:
            - `cargo install codex-memory --version ${{ steps.version.outputs.ci_version }}`
            - `cargo install codex-extra-memory-mcp --version ${{ steps.version.outputs.ci_version }}`
